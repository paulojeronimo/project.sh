#!/usr/bin/env sh
set -eu

PROJECT_ROOT="${PROJECT_ROOT:-$PWD}"
PROJECT_SH_REPO="${PROJECT_SH_REPO:-https://github.com/paulojeronimo/project.sh.git}"
PROJECT_SH_REF="${PROJECT_SH_REF:-main}"
PROJECT_SH_INFO_URL_PRIMARY="${PROJECT_SH_INFO_URL_PRIMARY:-https://paulojeronimo.com/project.sh/scripts/project.sh.info}"
PROJECT_SH_INFO_URL_FALLBACK="${PROJECT_SH_INFO_URL_FALLBACK:-https://raw.githubusercontent.com/paulojeronimo/project.sh/gh-pages/scripts/project.sh.info}"

TMP_DIR="$(mktemp -d)"
cleanup() {
  rm -rf "${TMP_DIR}"
}
trap cleanup EXIT INT TERM

REPO_DIR="${TMP_DIR}/project.sh"

if ! git clone --depth 1 --branch "${PROJECT_SH_REF}" "${PROJECT_SH_REPO}" "${REPO_DIR}" >/dev/null 2>&1; then
  git clone "${PROJECT_SH_REPO}" "${REPO_DIR}" >/dev/null 2>&1
  (
    cd "${REPO_DIR}"
    git checkout "${PROJECT_SH_REF}" >/dev/null 2>&1
  )
fi

mkdir -p "${PROJECT_ROOT}/scripts"
cp -R "${REPO_DIR}/scripts/." "${PROJECT_ROOT}/scripts/"

if ! curl -fsSL "${PROJECT_SH_INFO_URL_PRIMARY}" -o "${PROJECT_ROOT}/scripts/project.sh.info"; then
  curl -fsSL "${PROJECT_SH_INFO_URL_FALLBACK}" -o "${PROJECT_ROOT}/scripts/project.sh.info"
fi

if [ -f "${PROJECT_ROOT}/scripts/project.sh" ]; then
  chmod +x "${PROJECT_ROOT}/scripts/project.sh"
fi

ln -sfn "scripts/project.sh" "${PROJECT_ROOT}/project.sh"

echo "Installed scripts from ${PROJECT_SH_REPO}@${PROJECT_SH_REF}"
echo "Created link: ${PROJECT_ROOT}/project.sh -> scripts/project.sh"
echo "Saved metadata: ${PROJECT_ROOT}/scripts/project.sh.info"
